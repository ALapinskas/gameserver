<!DOCTYPE html>
<head>
    <title>Tic-Tac-Toe game app</title>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <script type="module" src="/node_modules/uikit/dist/uikit.min.js"></script>
</head>
<body>
    <div id="whoseTurn"></div>
    <div id="board">
        
    </div>
    <script>
        document.onreadystatechange = function () {
            if (document.readyState == "complete") {
                let popup = window.uikit.Popup,
                    formSwitcher = window.uikit.FormSwitchers,
                    formInput = window.uikit.FormInput,
                    roomValue,
                    playOptions = { 
                        SINGLE: "Single Player",
                        MULTIPLAYER: "Two Players"
                    },
                    socket,
                    isCreator = false,
                    applicationState = { whoseTurn:undefined, playerA:{}, playerB:{} },
                    gameBoard,
                    turnsOverlay,
                    loadingPopup = undefined
                    whoseTurnPopup = undefined;

                let popupContents = function() {
                    let wrapper = document.createElement('div'),
                        header = document.createElement('h1'),
                        howManyPlayers = new formSwitcher(
                            "howManyPlayers", 
                            "How many players?",
                            "radio",
                            "howMany",
                            Object.keys(playOptions).map((key) => playOptions[key])
                        ),
                        roomName = new formInput("name", "Room Name"),
                        submitButton = document.createElement("button");
                    header.innerText = "Tic-tac-toe";
                    submitButton.innerText = "Play!";
                    wrapper.style.padding = "10px";
                    howManyPlayers.wrapper.style["padding-bottom"] = "15px";
                    roomName.wrapper.style.display = "block";
                    roomName.wrapper.style["padding-bottom"] = "15px";

                    wrapper.appendChild(header);
                    wrapper.appendChild(howManyPlayers.wrapper);
                    wrapper.appendChild(roomName.wrapper);
                    howManyPlayers.values = ["Two Players"];
                    howManyPlayers.on("change", e => {
                        console.log("changed radio: ", e.target.value);
                        if(e.target.value === playOptions.SINGLE) {
                            roomName.wrapper.style.display = "none";
                        } else {
                            roomName.wrapper.style.display = "block";
                        }
                    });

                    submitButton.addEventListener("click", () => {
                        const value = howManyPlayers.values[0];
                        if(value === playOptions.SINGLE) {
                            alert("Sorry, single player game is not implemented yet! \n please choose Multiplayer one, \n and call a friend to play with you!");
                        } else {
                            if(roomName.value.trim().length === 0) {
                                alert("please type a room name to play!");
                            } else {
                                console.log("play");
                                roomValue = roomName.value.trim();
                                socket = io("http://localhost:9000", {withCredentials: true});
                                socket.on("created", (room, map) => {
                                    console.log("room created! Waiting for other player...");
                                    optionsPopup.close();
                                    loadingPopup = new popup("loading", loadingContents(), true);
                                    isCreator = true;
                                });
                                socket.on("joined", (room, map) => {
                                    console.log("some body joined! Starting the game!");
                                    optionsPopup.close();
                                    applicationState = map;
                                    if(loadingPopup) loadingPopup.close();
                                    console.log("whose turn: ", applicationState.whoseTurn);
                                    if(typeof applicationState.whoseTurn === "undefined") {
                                        whoseTurnPopup = new popup("whoseTurn", whoseTurnContents(), true);
                                    }
                                });
                                socket.on("log", (message) => {
                                    console.log("log from server: ", message);
                                });
                                socket.on("full", (message) => {
                                    alert("Sorry, this room is overflowed, choose another one");
                                });
                                socket.on("message", (message) => {
                                    console.log("message from server: ", message);
                                    switch(message.type) {
                                        case "who_first":
                                            if(!isCreator) { 
                                                whoseTurn = message.whoseTurn;
                                                console.log("Player " + message.whoseTurn + ", will be first!");
                                                if(loadingPopup) loadingPopup.close();
                                                drawBoard(whoseTurn);
                                                setTimeout(() => whoseTurnPopup.close(), 2000);
                                            }
                                    }
                                });
                                
                                socket.emit('create or join', roomValue, applicationState);
                            }
                        }
                    });

                    wrapper.appendChild(submitButton);
                    return wrapper;
                }
                const loadingContents = () => {
                    let wrapper = document.createElement("div"),
                        text = document.createElement("p");
                    wrapper.innerHTML = '<iframe src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>';
                    text.innerText = ("Waiting other player to join, please ask your friend to go to the address: " + window.location + ", and join the room: " + roomValue);
                    wrapper.appendChild(text);
                    wrapper.style.padding = "10px";
                    return wrapper;
                }
                const whoseTurnContents = () => {
                    let wrapper = document.createElement("div"),
                        text = document.createElement("p");
                    wrapper.innerHTML = '<iframe src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>';
                    text.innerText = ("Randomly choosing first player turn.");
                    if(isCreator) {
                        setTimeout(() => {
                            let player = ~~(Math.random() * 2) + 1;
                            console.log("Player ", player, " will be first!");
                            socket.emit("message", {type:"who_first", whoseTurn: player});
                            drawBoard(player);
                            if(whoseTurnPopup) {
                                whoseTurnPopup.close();
                            }
                        }, 5000);
                    }
                    return wrapper;
                }

                const optionsPopup = new popup("default", popupContents(), true);  
                
                const drawBoard = (player) => {
                    const windowWidth = window.innerWidth,
                        windowHeight = window.innerHeight,
                        boardDiv = document.getElementById("board"),
                        whoseTurnDiv = document.getElementById("whoseTurn");

                    let boardWidth = windowWidth,
                        ctxBoard,
                        ctxOverlay;
                    console.log("draw board");

                    whoseTurnDiv.innerText = whoseTurn && whoseTurn == 2 ? isCreator ? "Its your turn now" : "Now it is your opponent turn" : isCreator ? "Now it is your opponent turn" : "Its your turn now"; 
                    gameBoard = document.createElement("canvas");
                    turnsOverlay = document.createElement("canvas");
                    ctxBoard = gameBoard.getContext("2d");
                    ctxOverlay = turnsOverlay.getContext("2d");
                    
                    gameBoard.id = "GameBoard";
                    turnsOverlay.id = "TurnsOverlay";

                    if (windowWidth > windowHeight) {
                        while (boardWidth > windowHeight) {
                            boardWidth = windowWidth / 2;
                        }
                    } else {
                        boardWidth = windowHeight;
                        while (boardWidth > windowWidth) {
                            boardWidth = windowHeight / 2;
                        }
                    }

                    gameBoard.width = boardWidth;
                    gameBoard.height = boardWidth;

                    gameBoard.style.position = "absolute";
                    gameBoard.style.left = "25%";
                    gameBoard.style.top = "25%";

                    turnsOverlay.width = boardWidth;
                    turnsOverlay.height = boardWidth;

                    turnsOverlay.style.position = "absolute";
                    turnsOverlay.style.left = "25%";
                    turnsOverlay.style.top = "25%";

                    ctxBoard.fillStyle = "rgba(255, 255, 255, 0.3)";
                    ctxOverlay.fillStyle = "rgba(0, 0, 0, 0)"; 
                    ctxBoard.fillRect(0, 0, boardWidth, boardWidth);
                    ctxOverlay.fillRect(0, 0, boardWidth, boardWidth);


                    ctxBoard.strokeStyle = 'black';
                    ctxBoard.lineWidth = 5;

                    // draw a red line
                    ctxBoard.beginPath();
                    ctxBoard.moveTo(boardWidth/3, 0);
                    ctxBoard.lineTo(boardWidth/3, boardWidth);
                    ctxBoard.stroke();

                    ctxBoard.beginPath();
                    ctxBoard.moveTo(boardWidth/3 * 2, 0);
                    ctxBoard.lineTo(boardWidth/3 * 2, boardWidth);
                    ctxBoard.stroke();

                    ctxBoard.beginPath();
                    ctxBoard.moveTo(0, boardWidth/3);
                    ctxBoard.lineTo(boardWidth, boardWidth/3);
                    ctxBoard.stroke();

                    ctxBoard.beginPath();
                    ctxBoard.moveTo(0, boardWidth/3 * 2);
                    ctxBoard.lineTo(boardWidth, boardWidth/3 * 2);
                    ctxBoard.stroke();

                    boardDiv.appendChild(gameBoard);
                    boardDiv.appendChild(turnsOverlay);
                }
            }
        }
    </script>
</body>